#!/usr/bin/env bash
set -euo pipefail
bold=$(tput bold)
reset=$(tput sgr0)
orange=$'\033[38;5;208m'
green=$'\033[38;5;34m'
arrow=$'\u2192'
if (( EUID != 0 )); then
  printf "You must run this script as admin.\n"
  exit 1
fi
SHARE="parquet_files"
CONF_PATH="/etc/samba/smb.conf"
toggle() {
  local val="$1" # yes|no
  
  # First, remove ALL existing "read only" lines within the section
  sed -i "/^\[$SHARE\]/,/^\[/{/^[[:space:]]*read only[[:space:]]*=/d}" "$CONF_PATH"
  
  # Then add the new value right after the section header
  sed -i "/^\[$SHARE\]/a\   read only = ${val}" "$CONF_PATH"
}
needs_restart=false
case "${1-}" in
  0)
    toggle yes
    printf "    %s%s%s The share %s'%s'%s is now %sread-only%s.\n" "$bold" "$arrow" "$reset" "$bold" "$SHARE" "$reset" "$orange" "$reset"
    needs_restart=true
    ;;
  1)
    toggle no
    printf "    %s%s%s The share %s'%s'%s is now %swritable%s.\n" "$bold" "$arrow" "$reset" "$bold" "$SHARE" "$reset" "$green" "$reset"
    needs_restart=true
    ;;
  "" )
    # Extract the section and find read only value
    current_state=$(sed -n "/^\[$SHARE\]/,/^\[/{/^[[:space:]]*read only[[:space:]]*=/p}" "$CONF_PATH" | sed 's/.*=[[:space:]]*//' | tr -d ' ')
    
    printf "%sUsage:%s %s %s%s0%s=%s%sread-only%s, %s%s1%s=%s%swritable%s\n" "$bold" "$reset" "$(basename "$0")" "$bold" "$orange" "$reset" "$bold" "$orange" "$reset" "$bold" "$green" "$reset" "$bold" "$green" "$reset"
    
    if [[ "$current_state" == "yes" ]]; then
      printf "    %s%s%s The share %s'%s'%s is currently %sRead-Only%s\n" "$bold" "$arrow" "$reset" "$bold" "$SHARE" "$reset" "$orange" "$reset"
    else
      printf "    %s%s%s The share %s'%s'%s is currently %sWritable%s\n" "$bold" "$arrow" "$reset" "$bold" "$SHARE" "$reset" "$green" "$reset"
    fi
    ;;
  * )
    printf "%sUsage:%s %s %s%s0%s=%s%sread-only%s, %s%s1%s=%s%swritable%s\n" "$bold" "$reset" "$(basename "$0")" "$bold" "$orange" "$reset" "$bold" "$orange" "$reset" "$bold" "$green" "$reset" "$bold" "$green" "$reset"
    exit 2
    ;;
esac
if $needs_restart; then
  # Restart all Samba services
  systemctl restart smbd nmbd
  
  # Force Samba to reload the configuration
  smbcontrol all reload-config
  
  # Clear any cached connections for this share
  smbcontrol all close-share "$SHARE"
  
  printf "    %sServices restarted and configuration reloaded%s\n" "$green" "$reset"
fi
